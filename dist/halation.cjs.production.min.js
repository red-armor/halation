"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=require("react"),n=e(t),r=require("tapable"),o=e(require("invariant"));function a(){return(a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}var s,i,u,l=function(){function e(e){var t=e.type,n=e.prevSibling,r=e.nextSibling,o=e.children,a=e.name,s=e.strategies;this.key=e.key,this.name=a,this.prevSibling=n,this.nextSibling=r,this.type=t||"block",this.children=o,this.strategies=s}var t=e.prototype;return t.getChildKeys=function(){return this.children},t.getNextSibling=function(){return this.nextSibling},t.getPrevSibling=function(){return this.prevSibling},t.getName=function(){return this.name},t.getKey=function(){return this.key},t.getType=function(){return this.type},t.getStrategies=function(){return this.strategies},t.getRenderProps=function(){return{key:this.key,name:this.name,type:this.type}},e}();(s=exports.ModuleName||(exports.ModuleName={})).Model="model",s.Component="component",(i=exports.ModuleStatus||(exports.ModuleStatus={}))[i.Idle=0]="Idle",i[i.Pending=1]="Pending",i[i.Loaded=2]="Loaded",i[i.Error=3]="Error",(u=exports.StrategyType||(exports.StrategyType={})).flags="flags",u.event="event",u.runtime="runtime";var c=function(e,t){process},d=function(){function e(e){var t=e.getModel,n=e.getComponent,r=e.strategies;this._name=e.name,this._getModel=t,this._getComponent=n,this.statusMap=new Map([[exports.ModuleName.Model,exports.ModuleStatus.Idle],[exports.ModuleName.Component,exports.ModuleStatus.Idle]]),this.resolversMap=new Map([[exports.ModuleName.Model,[]],[exports.ModuleName.Component,[]]]),this.resolvedModulesMap=new Map([[exports.ModuleName.Model,null],[exports.ModuleName.Component,null]]),this._strategies=r||[],c()}var t=e.prototype;return t.getName=function(){return this._name},t.getComponent=function(){return this._getComponent},t.getStrategies=function(){return this._strategies},t.getModel=function(){return this._getModel},t.resolveModule=function(e){return e&&e.__esModule?e.default:e},t.load=function(e,t){var n=this,r=this.statusMap.get(e);return r===exports.ModuleStatus.Loaded?(c(),this.resolvedModulesMap.get(e)):new Promise((function(o){var a,s;switch(r){case exports.ModuleStatus.Idle:null===(a=n.resolversMap.get(e))||void 0===a||a.push(o),c(),n.statusMap.set(e,exports.ModuleStatus.Pending);break;case exports.ModuleStatus.Pending:return void(null===(s=n.resolversMap.get(e))||void 0===s||s.push(o))}var i=t.call(n);i&&Promise.resolve(i.call(n)).then((function(t){var r=n.resolveModule(t);(n.resolversMap.get(e)||[]).forEach((function(e){return e(r)})),n.resolvedModulesMap.set(e,r),c(),n.resolversMap.set(e,[]),n.statusMap.set(e,exports.ModuleStatus.Loaded)}),(function(){var t;t={type:"module",message:"'load' "+e+" fails"},console.error(t.message,t.type)}))}))},t.loadModel=function(){return this.load(exports.ModuleName.Model,this.getModel)},t.loadComponent=function(){return this.load(exports.ModuleName.Component,this.getComponent)},e}(),h=Function.call.bind(Object.prototype.toString),f=function(e){return"object"==typeof e&&"function"==typeof e.then},p="undefined"!=typeof Symbol?Symbol("tracker"):"__tracker__",g=function(e){return-1!==["[object Object]","[object Array]"].indexOf(h(e))},v=function(e){var r=e.hooks,o=e.block,s=e.moduleMap,i=e.loadManagerMap,u=e.blockRenderFn,l=t.useState({}),d=l[0],h=l[1],p=o.getKey(),g=o.getName(),v=t.useRef(),M=t.useRef(!1),m=t.useRef(!1),y=i.get(p),b=t.useRef(null),k=t.useCallback((function(){var e=null==y?void 0:y.shouldModuleLoad();f(e)?e.then((function(e){e&&E()})):e&&E()}),[]),_=t.useCallback((function(e){var t=e[0],n=e[1],r={};t.success&&(r.model=t.value),n.success&&(r.Component=n.value),h(r)}),[]),E=t.useCallback((function(){var e;if(c(),b.current&&(null===(e=b.current)||void 0===e||e.call(null)),!M.current){var t,n=s.get(g);if(n){r.register.call(p,o);var a=n.loadModel(),i=n.loadComponent();f(a)||f(i)?(t=[Promise.resolve(n.loadModel()),Promise.resolve(n.loadComponent())],Promise.all(t.map((function(e){return function(e){return e.then((function(e){return{value:e,success:!0}}),(function(e){return{value:e,success:!1}}))}(e)})))).then((function(e){_(e)})):(c(),_([{success:!0,value:a},{success:!0,value:i}]))}}}),[]);if(m.current||(m.current=!0,b.current=y.bindLoadRoutine(k),k()),!d.Component)return null;var x=null;"function"==typeof u&&(x=u(o.getRenderProps()));var C=t.forwardRef((function(e,n){return t.createElement(d.Component,a({},e,{$_modelKey:y.getKey(),forwardRef:n}))}));return n.createElement(t.Fragment,null,x?t.createElement(x,e,n.createElement(C,Object.assign({},e,{ref:v}))):n.createElement(C,Object.assign({},e,{ref:v})),n.createElement((function(){return null}),null))},M=function e(n){var r=n.block,s=n.nodeMap,i=n.blockRenderFn,u=n.addBlockLoadManager,l=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)t.indexOf(n=a[r])>=0||(o[n]=e[n]);return o}(n,["block","nodeMap","blockRenderFn","addBlockLoadManager"]),d=[],h=r.getChildKeys(),f=r.getKey(),p=r.getName(),g=n.moduleMap.get(p);g||o(!1);var M=r.getStrategies()||g.getStrategies()||[];return u({blockKey:f,moduleName:p,strategies:M}),c(),h.forEach((function(n){var r=s.get(n);r&&d.push(t.createElement(e,a({key:n,block:r,nodeMap:s,blockRenderFn:i,addBlockLoadManager:u},l),null))})),t.createElement(v,n,d)},m=function(){function e(e){var t=e.store,n=e.moduleName,r=e.strategies,o=e.moduleMap,a=e.proxyEvent,s=e.dispatchEvent,i=e.lockCurrentLoadManager,u=e.releaseCurrentLoadManager;this._key=e.blockKey,this._store=t,this.strategies=this.sort(r),this._moduleName=n,this._moduleMap=o,this._lockCurrentLoadManager=i,this._releaseCurrentLoadManager=u,this._proxyEvent=a,this._dispatchEvent=s,this.teardownEffects=[],this._runtimeVerifyEffect=null,this._loadRoutine=null}var t=e.prototype;return t.getKey=function(){return this._key},t.addTeardown=function(e){this.teardownEffects.push(e)},t.teardown=function(){this.teardownEffects.forEach((function(e){return e()}))},t.sort=function(e){var t={flags:0,event:1,runtime:2};return e.sort((function(e,n){return t[e.type]-t[n.type]}))},t.update=function(){this.teardown(),this._loadRoutine&&this._loadRoutine()},t.mountModel=function(e,t,n){void 0===n&&(n={});var r=this._key;this._store.injectModel(r,t,n);var o=e(this._store.getState()[r]);return o||this._store.subscribe(this.update.bind(this)),!!o},t.startVerifyRuntime=function(e){var t,n=this;"function"==typeof this._runtimeVerifyEffect&&(this._runtimeVerifyEffect(),this._runtimeVerifyEffect=null),c();var r=null===(t=this._moduleMap.get(this._moduleName))||void 0===t?void 0:t.loadModel(),o=null;return f(r)?r.then((function(t){var r=t.call(null);return n.mountModel(e,r,{})})).catch((function(e){return c(),!1})):"function"==typeof r&&(o=r.call(null),this.mountModel(e,o,{}))},t.shouldModuleLoad=function(){var e=this.strategies.length;this._lockCurrentLoadManager(this);for(var t=0;t<e;t++){var n=this.strategies[t],r=n.resolver,o=!1;switch(n.type){case exports.StrategyType.event:o=!!r({event:this._proxyEvent,dispatchEvent:this._dispatchEvent});break;case exports.StrategyType.runtime:return this.startVerifyRuntime(r)}if(!o)return this._releaseCurrentLoadManager(),!1}return this._releaseCurrentLoadManager(),!0},t.bindLoadRoutine=function(e){var t=this;return this._loadRoutine=e,function(){return t._loadRoutine=null}},e}(),y=function e(t){var n=t.base,r=t.path,o=void 0===r?[]:r,s=t.reportAccessPaths,i=n;return g(n)&&(i=new Proxy(a({},n),{get:function(t,n,r){if(n===p)return Reflect.get(t,n,r);var a=Reflect.get(t,p,r),i=a.base;if("base"===n)return i;var u=i[n],l=a.childrenProxies,c=o.concat(n);return s(c),g(u)?(l[n]?l[n].base!==u&&(l[n]=new e({base:u,path:c,reportAccessPaths:s})):l[n]=new e({base:u,path:c,reportAccessPaths:s}),l[n]):(l[n]&&delete l[n],u)},set:function(e,t,n,r){return Reflect.set(e,t,n,r)}}),Object.defineProperty(i,p,{value:{base:n,childrenProxies:{},effects:[],paths:[]},enumerable:!1,writable:!0})),i},b=function(e){return e.join("_")},k=function(){function e(e){var t=e.key;this.childMap={},this.effectMap={},this._key=t,this._slugKey=""}var t=e.prototype;return t.getKey=function(){return this._key},t.addChild=function(t,n){t.reduce((function(t,n){return t.childMap[n]||(t.childMap[n]=new e({key:n})),t.childMap[n]}),this).addEffect(n)},t.addEffect=function(e){var t=this,n=e.getKey();this.effectMap[n]={loadManager:e},e.addTeardown((function(){return delete t.effectMap[n]}))},t.addChildren=function(e){var t=this,n=e.loadManager;e.paths.forEach((function(e){t.addChild(e,n)}))},t.triggerEffect=function(e){var t=e.reduce((function(e,t){return e&&e.childMap&&e.childMap[t]?e.childMap[t]:e}),this);for(var n in t.effectMap)t.effectMap[n].loadManager.update()},e}(),_=function(){function e(e){this.events=e.events,this.eventObject=this.initEventObject(),this._proxyEvent=new y({path:[],base:this.eventObject,reportAccessPaths:this.reportAccessPaths.bind(this)}),this.accessPaths=[],this.effectNodeTree=new k({key:"root"}),this.currentLoadManager=null}var t=e.prototype;return t.updateEventValue=function(e){var t=e.event,n=e.value;this._proxyEvent[t]!==n&&(this._proxyEvent[t]=n,this._proxyEvent.base[t]=n,this.effectNodeTree.triggerEffect([t]))},t.getProxyEvent=function(){return this._proxyEvent},t.reportAccessPaths=function(e){this.accessPaths.push(e)},t.initEventObject=function(){return this.events.reduce((function(e,t){var n;return a({},e,((n={})[t]={},n))}),{})},t.setLoadManager=function(e){this.accessPaths=[],this.currentLoadManager=e},t.releaseLoadManager=function(){var e,t=function(e){for(var t=e.slice(),n={},r=[],o=t.length-1;o>=0;o--)for(var a=t[o].slice(),s=a.length,i=!1,u=0;u<s;u++){var l=b(a),c=n[l]||0;if(i)n[l]=c+1,a.pop();else{if(c){n[l]=c-1;break}!function(){var e=a.slice(),t=b(e);r.find((function(e){return b(e)===t}))||r.push(e),i=!0,a.pop()}()}}return r}(this.accessPaths);this.currentLoadManager&&this.effectNodeTree.addChildren({paths:t,loadManager:this.currentLoadManager}),c(0,null===(e=this.currentLoadManager)||void 0===e||e.getKey()),this.currentLoadManager=null},t.addEffect=function(){},e}();exports.Halation=function(e){var o,s;function i(t){var n;n=e.call(this,t)||this;var o=t.name,a=t.store,s=t.events,i=t.registers,u=t.blockRenderFn,l=t.rootRenderFn;return n.halationState=t.halationState,n.blockRenderFn=u,n.nodeMap=new Map,n.name=o,n.moduleMap=new Map,n.loadManagerMap=new Map,n.rootRenderFn=l,n.hooks={register:new r.SyncHook(["block"])},n._refs={},n.runtimeRegisterModule=new Map,n.eventTracker=new _({events:s||[]}),n.createBlockNode(n.halationState),n.startListen(),n.store=a,i.forEach((function(e){var t=e.call(null),r=t.name,o=t.getModel,a=t.getComponent,s=t.strategies;if(!n.moduleMap.get(r)){var i=new d({name:r,getComponent:a,getModel:o,strategies:s||[]});n.moduleMap.set(r,i)}})),n}s=e,(o=i).prototype=Object.create(s.prototype),o.prototype.constructor=o,o.__proto__=s;var u=i.prototype;return u.startListen=function(){for(var e in this.hooks){var t=this.hooks[e];t.tap(e,(function(){})),t.intercept({register:function(e){return c(),e}})}},u.getName=function(){return this.name},u.createBlockNode=function(e){var t=this;e.forEach((function(e){t.nodeMap.set(e.key,new l(e))})),c()},u.getRefs=function(){return this._refs},u.getPropsAPI=function(){return{hooks:this.hooks,nodeMap:this.nodeMap,moduleMap:this.moduleMap,loadManagerMap:this.loadManagerMap,refs:this.getRefs(),addBlockLoadManager:this.addBlockLoadManager.bind(this)}},u.addBlockLoadManager=function(e){var t=e.blockKey,n=e.moduleName,r=e.strategies;return this.loadManagerMap.get(t)?(c(),!1):(this.loadManagerMap.set(t,new m({store:this.store,blockKey:t,strategies:r,moduleName:n,moduleMap:this.moduleMap,dispatchEvent:this.dispatchEvent.bind(this),proxyEvent:this.eventTracker.getProxyEvent(),lockCurrentLoadManager:this.lockCurrentLoadManager.bind(this),releaseCurrentLoadManager:this.releaseCurrentLoadManager.bind(this)})),!0)},u.lockCurrentLoadManager=function(e){this.eventTracker.setLoadManager(e)},u.releaseCurrentLoadManager=function(){this.eventTracker.releaseLoadManager()},u.dispatchEvent=function(e){var t=e;"[object String]"===h(e)&&(t={event:e,value:!0}),function(e){return"[object Object]"===h(e)}(t)&&this.eventTracker.updateEventValue(t)},u.render=function(){for(var e=this.nodeMap.values().next().value,r=[];e;){r.push(t.createElement(M,a({block:e,key:e.getKey(),blockRenderFn:this.blockRenderFn},this.getPropsAPI()),null));var o=e.getNextSibling();e=this.nodeMap.get(o)}return"function"==typeof this.rootRenderFn?n.createElement(this.rootRenderFn,a({},this.getPropsAPI()),r):n.createElement(t.Fragment,{},r)},i}(t.PureComponent),exports.Node=l;
//# sourceMappingURL=halation.cjs.production.min.js.map
